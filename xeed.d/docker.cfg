[xeed.tools.docker]

[xeed.tools.docker.vars]
image_tag: {xeed.vars.project}-docker:{xeed.vars.HASH}
socket_path: /var/run/docker.sock
dockerfile_path: {xeed.vars.cachedir}/{xeed.vars.HASH}/xeed-docker.df

[xeed.tools.docker.cmds.docker]
type: xeed.types.tool.subtypes.clitool
cmdstr: {xeed.vars.PREFIX} docker/build > /dev/null 2>&1 && \
  docker run -it \
  -v {xeed.tools.docker.vars.socket_path}:{xeed.tools.docker.vars.socket_path} \
  -v {xeed.vars.env.PWD}:{xeed.vars.env.PWD} \
  -w {xeed.vars.env.PWD} \
  {xeed.tools.docker.vars.image_tag} \
  docker {xeed.vars.cli.extra_args}

[xeed.tools.docker.files.docker]
path: {xeed.tools.docker.vars.dockerfile_path}
contents:
  FROM debian:latest
  ARG DOCKER
  RUN groupadd -g $DOCKER docker
  RUN apt-get update
  RUN apt-get install -y \
      ca-certificates \
      curl
  RUN curl -fsSL \
      https://get.docker.com \
      -o get-docker.sh
  RUN sh get-docker.sh
  RUN rm get-docker.sh
  RUN apt-get install -y \
      docker-ce \
      docker-ce-cli \
      containerd.io \
      docker-buildx-plugin \
      docker-compose-plugin
  RUN groupadd -g {xeed.vars.user.GID} {xeed.vars.user.NAME}
  RUN useradd -u {xeed.vars.user.UID} -g {xeed.vars.user.GID} -G docker {xeed.vars.user.NAME}
  USER {xeed.vars.user.NAME}

[xeed.tools.docker.cmds.docker/build]
type: xeed.types.tool.subtypes.clitool
cmdstr: docker build \
  --build-arg DOCKER=$({xeed.vars.PREFIX} docker/gid) \
  -f {xeed.tools.docker.vars.dockerfile_path} \
  -t {xeed.tools.docker.vars.image_tag} \
  ./

[xeed.tools.docker.cmds.docker/gid]
type: xeed.types.tool.subtypes.clitool
cmdstr: getent group docker | cut -d: -f3