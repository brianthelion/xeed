[xeed.tools.gemini]
# Removed direct variable definitions, as they are now in the 'vars' block.
# url: https://raw.githubusercontent.com/google-gemini/gemini-cli/refs/heads/main/Dockerfile

# Centralized variables for the 'gemini' tool suite
[xeed.tools.gemini.vars]
dockerfile_path: {xeed.vars.cachedir}/{xeed.vars.HASH}/xeed-gemini.df
image_tag: xeed-gemini-cli:{xeed.vars.HASH}
log_path: {xeed.vars.cachedir}/{xeed.vars.HASH}/log
key_dir: {xeed.vars.env.HOME}/.gemini
settings_path: {xeed.vars.cachedir}/{xeed.vars.HASH}/xeed-gemini.json

# [xeed.tools.gemini.cmds.gemini/fetch]
# cmdstr: wget {xeed.tools.gemini.url} -O {xeed.tools.gemini.vars.dockerfile_path}

[xeed.tools.gemini.files.dockerfile]
# Updated path to reference the vars block directly.
path: {xeed.tools.gemini.vars.dockerfile_path}
contents:
  FROM node:20-slim
  ARG HOST_USER={xeed.vars.user.NAME}
  ARG HOST_UID={xeed.vars.user.UID}
  ARG HOST_GID={xeed.vars.user.GID}
  RUN userdel -f node
  RUN if getent group node; then groupdel node; fi
  RUN groupadd -g "$HOST_GID" "$HOST_USER"
  RUN useradd -m -u "$HOST_UID" -g "$HOST_GID" -s /bin/bash "$HOST_USER"
  RUN apt-get update
  RUN apt-get install -y git curl vim procps
  RUN rm -rf /var/lib/apt/lists/*
  RUN npm install -g @google/gemini-cli
  ENTRYPOINT ["gemini"]
  # RUN groupadd -g {xeed.vars.user.GID} {xeed.vars.user.NAME}
  # RUN useradd -u {xeed.vars.user.UID} -g {xeed.vars.user.GID} {xeed.vars.user.NAME}
  USER {xeed.vars.user.NAME}

[xeed.tools.gemini.cmds.gemini/build]
type: xeed.types.tool.subtypes.clitool
cmdstr: docker build \
  -f {xeed.tools.gemini.vars.dockerfile_path} \
  -t {xeed.tools.gemini.vars.image_tag} \
  ./

[xeed.tools.gemini.cmds.gemini/cli]
type: xeed.types.tool.subtypes.clitool
cmdstr: {xeed.vars.XEED_CMD} gemini/build >> {xeed.tools.gemini.vars.log_path} 2>&1 && \
  mkdir -p {xeed.tools.gemini.vars.key_dir} && \
  {xeed.vars.XEED_CMD} docker run -it \
  -v {xeed.vars.env.PWD}:{xeed.vars.env.PWD} \
  -v {xeed.tools.gemini.vars.key_dir}:{xeed.tools.gemini.vars.key_dir} \
  -w {xeed.vars.env.PWD} \
  {xeed.tools.gemini.vars.image_tag} \
  gemini {xeed.vars.cli.extra_args}

# [xeed.tools.gemini.files.settings]
# path: {xeed.tools.gemini.vars.settings_path}
# contents:
#   {
#     "tools": {
#       "allowed": [
#         "run_shell_command",
#         "write_file",
#         "read_file",
#         "search_file_.content",
#         "web_fetch",
#         "google_web_search"
#       ],
#       "approvalMode": "alwaysAsk"
#     }